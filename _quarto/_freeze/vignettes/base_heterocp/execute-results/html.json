{
  "hash": "0fd4f73f22eed3e123617e41cf9818e4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Data Generation Process of base_heterocp\"\nauthor: Kazuharu Yanagimoto\ndate: today\n---\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(unitdid)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(purrr)\n```\n:::\n\n\n## Data Generation Process\n\nThe sample data set `base_heterocp` is generated by `unitdid::gen_heterocp()` with seed `1234`.\n\n```r\nset.seed(1234)\nbase_heterocp <- gen_heterocp()\n```\n\nInside the function `gen_heterocp()`, the following steps are performed.\n\n### 1. Generate $i = \\{1, \\dots, 1000\\}$ individuals\n\nGenerate $i = \\{1, \\dots, 1000\\}$ individuals with age at child birth $a_i$\nfrom a multinomial distribution of $f(a)$.\n\n\n$$\nf(a) = \\begin{cases}\n\\frac{a - 14}{15 \\cdot 16} & \\text{if } a \\in \\{15, \\dots, 29\\} \\\\\n\\frac{45 - a}{15 \\cdot 16} & \\text{if } a \\in \\{30, \\dots, 44\\} \\\\\n\\end{cases}\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nbase_heterocp |>\n  distinct(id, .keep_all = TRUE) |>\n  mutate(event_age = cyear - byear) |>\n  summarize(n = n(), .by = event_age) |>\n  mutate(density = n / sum(n)) |>\n  ggplot(aes(x = event_age, y = density)) +\n  geom_col() +\n  labs(x = \"Age at First Childbirth\", y = NULL) +\n  theme_minimal() +\n  theme(panel.grid.minor = element_blank(),\n        panel.grid.major.x = element_blank())\n```\n\n::: {.cell-output-display}\n![](base_heterocp_files/figure-html/unnamed-chunk-2-1.svg){width=672}\n:::\n:::\n\n\n### 2. Generate Individual FE $\\alpha_i$ and Time FE $\\lambda_t$\n\nGenerate individual fixed effects $\\alpha_i$ and time fixed effects $\\lambda_t$ from normal distributions.\n\n$$\n\\alpha_{i} \\sim \\mathcal{N}(0.15, 0.1),\\, \\lambda_{t} \\sim \\mathcal{N}(0, 0.1)\n$$\n\n### 3. Generate Heterogeneous Treatment Effect $\\tau_{i, k}$\n\nFor individual $i$ with age at first childbirth $a_i$, draw $\\tau_{i, k} \\sim \\mathcal{N}(\\mu(a_i, k), \\sigma(a_i, k))$ where\n\n$$\n\\begin{aligned}\n\\mu(a) &= -1.2 + 0.3\\log(a) \\\\\n\\sigma(a) &= 2.8 - 0.8\\log(a) \\\\\n\\mu(a, k) &= \\begin{cases}\n\\frac{1}{3}\\mu(a) & \\text{if } k = 0 \\\\\n\\mu(a) & \\text{if } k = 1 \\\\\n0.05 + 1.5\\mu(a) - 0.01k & \\text{if } k \\ge 2 \\\\\n\\end{cases} \\\\\n\\sigma(a, k) &= \\begin{cases}\n\\frac{1}{3}\\sigma(a) & \\text{if } k = 0 \\\\\n\\sigma(a) & \\text{if } k = 1 \\\\\n0.01 + \\sigma(a) + 0.01k & \\text{if } k \\ge 2 \\\\\n\\end{cases}\n\\end{aligned}\n$$\n\n### 4. Generate Outcome $y_{it}$\n\n$$\ny_{it} = \\alpha_i + \\lambda_t + \\tau_{i, k} + \\varepsilon_{it}\n$$\n\nwhere $\\varepsilon_{it} \\sim \\mathcal{N}(0, 025)$.\n\n## Simulation\n\nTo see its estimation properties,\nI simulate the data set 100 times and compare the true values with\nthe mean, 2.5% quantile, and 97.5% quantile of the estimated values.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"show\"}\nset.seed(1234)\nn_sim <- 100\n\nsim <- function() {\n  mdl_base <- gen_heterocp(size_cohort = 1000) |>\n    unitdid(yname = \"y\",\n          iname = \"id\",\n          tname = \"year\",\n          ename = \"cyear\",\n          bname = \"byear\",\n          compute_varcov = \"var\")\n\n  summary(mdl_base, agg = \"event_age\")\n}\n\npath_sim <- here::here(\"vignettes/simulated.rds\")\n\nif (!file.exists(path_sim)) {\n  simulated <- map(1:n_sim, ~sim(), .progress = TRUE) |>\n    list_rbind()\n  save(simulated, file = path_sim)\n} else {\n  load(path_sim)\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nval_true <- tibble(\n  event_age = 25:34,\n  tau1 = -1.2 + 0.3 * log(event_age),\n  sd1 = 3 - 0.75 * log(event_age)) |>\n  slice(rep(1:n(), each = 6)) |>\n  mutate(rel_time = rep(0:5, 10),\n         mean = case_when(\n           rel_time == 0 ~ tau1 / 3,\n           rel_time == 1 ~ tau1,\n           rel_time > 1 ~ 0.05 + 1.5 * tau1 - 0.02 * rel_time),\n         sd = case_when(\n            rel_time == 0 ~ sd1 / 3,\n            rel_time == 1 ~ sd1,\n            rel_time > 1 ~ 0.01 + sd1 + 0.02 * rel_time),\n         lbl = \"Truth\") |>\n  select(-c(tau1, sd1))\n\ndf_plot <- simulated |>\n  mutate(sd = sqrt(var)) |>\n  summarize(across(c(mean, sd),\n                   list(\"lci\" = ~quantile(.x, 0.025),\n                        \"rci\" = ~quantile(.x, 0.975))),\n            across(c(mean, sd), mean),\n            .by = c(event_age, rel_time)) |>\n  mutate(lbl = \"Simulation\") |>\n  bind_rows(val_true) |>\n  mutate(lbl_facet = paste0(\"Age \", event_age)) |>\n  filter(between(event_age, 25, 34))\n```\n:::\n\n\n### Mean of $\\tau_{ik}$\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndf_plot |>\n  ggplot(aes(x = rel_time, y = mean,\n             ymin = mean_lci, ymax = mean_rci,\n             color = lbl, shape = lbl)) +\n  geom_point(position = position_dodge(width = 0.3)) +\n  geom_errorbar(width = 0.2,\n                position = position_dodge(width = 0.3)) +\n  geom_vline(xintercept = -1, linetype = \"dashed\") +\n  geom_hline(yintercept = 0) +\n  scale_color_manual(values = c(\"#009F8C\", \"#B75C9D\")) +\n  facet_wrap(~lbl_facet, ncol = 5) +\n  labs(x = \"Time to Treatment\", y = NULL,\n       color = NULL, shape = NULL) +\n  theme_minimal() +\n  theme(panel.grid.minor = element_blank(),\n        panel.grid.major.x = element_blank(),\n        legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](base_heterocp_files/figure-html/unnamed-chunk-4-1.svg){width=672}\n:::\n:::\n\n\n### Standard Deviation of $\\tau_{ik}$\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\ndf_plot |>\n  ggplot(aes(x = rel_time, y = sd,\n             ymin = sd_lci, ymax = sd_rci,\n             color = lbl, shape = lbl)) +\n  geom_point(position = position_dodge(width = 0.3)) +\n  geom_errorbar(width = 0.2,\n                position = position_dodge(width = 0.3)) +\n  geom_vline(xintercept = -1, linetype = \"dashed\") +\n  geom_hline(yintercept = 0) +\n  scale_color_manual(values = c(\"#009F8C\", \"#B75C9D\")) +\n  facet_wrap(~lbl_facet, ncol = 5) +\n  labs(x = \"Time to Treatment\", y = NULL,\n       color = NULL, shape = NULL) +\n  theme_minimal() +\n  theme(panel.grid.minor = element_blank(),\n        panel.grid.major.x = element_blank(),\n        legend.position = \"bottom\")\n```\n\n::: {.cell-output-display}\n![](base_heterocp_files/figure-html/unnamed-chunk-5-1.svg){width=672}\n:::\n:::\n",
    "supporting": [
      "base_heterocp_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}