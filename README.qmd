<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  message = FALSE,
  warning = FALSE,
  dev = "svg"
)
```

# unitdid

<!-- badges: start -->
<!-- badges: end -->

The `unitdid` package provides a set of functions for the analysis of
the unit-level difference-in-differences ([Arkhangelsky, Yanagimoto, and Zohar 2024](https://arxiv.org/abs/2403.19563)).

## Installation

You can install the development version of unitdid from [GitHub](https://github.com/kazuyanagimoto/unitdid) with:

``` r
# install.packages("remotes")
remotes::install_github("kazuyanagimoto/unitdid")
```

## Example

This is a basic example with the simulated `base_heterocp` data set:

```{r example}
library(unitdid)
library(dplyr)
library(ggplot2)

base_heterocp |>
  head()
```

Individual-level child penalties are estimated by `unitdid()`:

```{r mdl_unitdid}
mdl_base <- base_heterocp |>
  unitdid(yname = "y",
        iname = "id",
        tname = "year",
        ename = "cyear",
        bname = "byear")

# Estimated individual-level child penalties (y_tilde)
get_unitdid(mdl_base)
```

### Aggregation of Individual-level Child Penalties

They can be aggregated to the `full`,
`event` (year at event (treatment). Mainly for staggered DiD design),
`event_age` (age at event. Mainly for child penalties) levels:

```{r agg_full}
summary(mdl_base) # default agg = "full"
```

```{r agg_cage}
sum_eage <- summary(mdl_base, agg = "event_age")

sum_eage |>
  filter(rel_time == 0) |>
  mutate(rel_time = -1,
         mean = 0) |>
  bind_rows(sum_eage) |>
  filter(between(event_age, 25, 34)) |>
  mutate(lbl_facet = paste0("Age ", event_age)) |>
  ggplot(aes(x = rel_time, y = mean)) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  facet_wrap(~lbl_facet, ncol = 5) +
  labs(x = "Time to First Childbirth",
       y = "Child Penalties on y") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank())
```

### Variance of Individual-level Child Penalties

Since the individual-level child penalties are estimated with measurement errors,
the variance of the `y_tilde` is not equal to the variance of
the individual-level child penalties.

The `compute_varcov = "var"` option of the `unitdid` estimates the variance of
the measurement errors and the variance of the individual-level child penalties
by subtracting the variance of the measurement errors from the variance of `y_tilde`

```{r var_cage}
mdl_base <- base_heterocp |>
  unitdid(yname = "y",
        iname = "id",
        tname = "year",
        ename = "cyear",
        bname = "byear",
        compute_varcov = "var")

sum_eage <- summary(mdl_base, agg = "event_age")

sum_eage |>
  filter(rel_time == 0) |>
  mutate(rel_time = -1,
         var = 0) |>
  bind_rows(sum_eage) |>
  filter(between(event_age, 25, 34)) |>
  mutate(lbl_facet = paste0("Age ", event_age)) |>
  ggplot(aes(x = rel_time, y = sqrt(var))) +
  geom_point() +
  geom_line() +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_hline(yintercept = 0) +
  facet_wrap(~lbl_facet, ncol = 5) +
  labs(x = "Time to First Childbirth",
       y = "S.D. of Child Penalties") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank())
```

## References

Arkhangelsky, Dmitry, Kazuharu Yanagimoto, and Tom Zohar. 2024. "Flexible Analysis of Individual Heterogeneity in Event Studies: Application to the Child Penalty." arXiv. [https://arxiv.org/abs/2403.19563](https://arxiv.org/abs/2403.19563).